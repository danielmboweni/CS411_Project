{"version":3,"sources":["../../src/client/socket.es6"],"names":[],"mappings":"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","file":"socket.js","sourcesContent":["import ClientError  from '../error';\nimport debugBase    from 'debug';\n\nvar debug = debugBase('develop');\n\nfunction catchErrorMessage(error) {\n\tswitch (error.type) {\n\t\tcase 'validation':\n\t\tcase 'client':\n\t\t\treturn error.message;\n\t\tdefault:\n\t\t\t// TODO: debug(error.stack);\n\t\t\tdebug(error.stack);\n\t\t\treturn 'Unknown error';\n\t}\n}\n\n/**\n * @function socketError\n * @param {String} event\n * @param {Error|String} error\n * @returns {Error}\n */\nfunction socketError(event, error) {\n\tvar sError = new Error();\n\n\tsError.event = String(event);\n\n\tswitch (Object.prototype.toString.call(error)) {\n\t\tcase '[object Error]':\n\t\t\tsError.message = error.message;\n\t\t\tbreak;\n\t\tcase '[object String]':\n\t\t\tsError.message = error;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsError.message = String(error);\n\t}\n\n\treturn sError;\n}\n\nclass ClientSocket {\n\tconstructor() {\n\t\tthis.emitResult.transform = function (data, next) {\n\t\t\tnext(data);\n\t\t};\n\n\t\tthis.emitError.transform = function (data, next) {\n\t\t\tnext(data);\n\t\t};\n\n\t\tthis.emitError.transformOn = (event, cb) => {\n\t\t\tif (!this.emitError.__transforms) {\n\t\t\t\tthis.emitError.__transforms = {}\n\t\t\t}\n\n\t\t\tif (!this.emitError.__transforms[event]) {\n\t\t\t\tthis.emitError.__transforms[event] = [];\n\t\t\t}\n\n\t\t\tthis.emitError.__transforms[event].push(cb);\n\n\t\t\treturn this.emitResult;\n\t\t};\n\n\t\tthis.emitResult.transformOn = (event, cb) => {\n\t\t\tif (!this.emitResult.__transforms) {\n\t\t\t\tthis.emitResult.__transforms = {}\n\t\t\t}\n\n\t\t\tif (!this.emitResult.__transforms[event]) {\n\t\t\t\tthis.emitResult.__transforms[event] = [];\n\t\t\t}\n\n\t\t\tthis.emitResult.__transforms[event].push(cb);\n\n\t\t\treturn this.emitResult;\n\t\t};\n\t}\n\n\temitError(socket, event, data) {\n\t\tvar index      = 0,\n\t\t    transforms = this.emitError.__transforms || {},\n\t\t    transformCb;\n\n\t\tfunction nextTransform(data) {\n\t\t\ttransformCb = transforms[event] ? transforms[event][index] : null;\n\n\t\t\tif (transformCb) {\n\t\t\t\ttransformCb(data, function (data) {\n\t\t\t\t\tindex++;\n\n\t\t\t\t\tif (transforms.length === index) {\n\t\t\t\t\t\tsocket.emit(event, { error: data });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnextTransform(data);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tsocket.emit(event, { error: data });\n\t\t\t}\n\t\t}\n\n\t\tthis.emitError.transform(data, (data) => {\n\t\t\tnextTransform(data);\n\t\t});\n\t}\n\n\temitResult(socket, event, data) {\n\t\tvar index      = 0,\n\t\t    transforms = this.emitResult.__transforms || {},\n\t\t    transformCb;\n\n\t\tfunction nextTransform(data) {\n\t\t\ttransformCb = transforms[event] ? transforms[event][index] : null;\n\n\t\t\tif (transformCb) {\n\t\t\t\ttransformCb(data, function (data) {\n\t\t\t\t\tindex++;\n\n\t\t\t\t\tif (transforms.length === index) {\n\t\t\t\t\t\tsocket.emit(event, { result: data });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnextTransform(data);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tsocket.emit(event, { result: data });\n\t\t\t}\n\t\t}\n\n\t\tthis.emitResult.transform(data, (data) => {\n\t\t\tnextTransform(data);\n\t\t});\n\t}\n\n\tonAuthenticate(client, socket, data = {}) {\n\t\tclient.emit(client.EVENTS.AUTHENTICATE, socket, data, (error) => {\n\t\t\tif (error) {\n\t\t\t\treturn this.emitError(socket, 'login', { message: error.message || error });\n\t\t\t}\n\n\t\t\tif (!client.authorize(socket)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tclient.members.add(socket.user, socket);\n\n\t\t\tthis.emitResult(socket, 'login', { user: socket.user });\n\t\t\tthis.emitResult(socket, 'authenticate', { user: socket.user });\n\t\t});\n\t}\n\n\tonCreate(client, socket, data = {}) {\n\t\tclient.create(data, socket.user)\n\t\t\t.then((chat) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.CREATE, { message: 'Chat created', data: chat.toJSON() });\n\n\t\t\t\tclient.rooms.addMembers(\n\t\t\t\t\tchat.get('_id'),\n\t\t\t\t\tclient.members.get(chat.get('members'))\n\t\t\t\t);\n\n\t\t\t\tclient.members.get(chat.get('members'))\n\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.JOIN, {\n\t\t\t\t\t\t\tmessage: 'Join to chat',\n\t\t\t\t\t\t\tdata:    chat.toJSON()\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\treturn this.emitError(socket, client.EVENTS.CREATE, { message: error.message });\n\t\t\t});\n\t}\n\n\tonLeave(client, socket, data = {}) {\n\t\tvar chat;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\treturn client.leave(chat, socket.user)\n\t\t\t})\n\t\t\t.then((member) => {\n\t\t\t\tclient.rooms.removeMember(chat.get('_id'), member);\n\n\t\t\t\tlet receivers = chat.get('members').concat(member),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.leaveMember) {\n\t\t\t\t\tclient.newSystemMessage(chat, { whoLeaved: member })\n\t\t\t\t\t\t.then((message) => {\n\t\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWSYSTEMMESSAGE, {\n\t\t\t\t\t\t\t\t\tmessage: 'New system message', data: message.toJSON(), chatId: chat.get('_id')\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.LEAVE, {\n\t\t\t\t\t\tmessage: 'The member leaved',\n\t\t\t\t\t\tdata:    member,\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.LEAVE, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonAddMember(client, socket, data = {}) {\n\t\tvar chat, countBefore, countAfter;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\tcountBefore = chat.get('members').length;\n\n\t\t\t\treturn client.addMember(chat, data.member, socket.user)\n\t\t\t})\n\t\t\t.then((member) => {\n\t\t\t\tcountAfter = chat.get('members').length;\n\n\t\t\t\tif (countBefore === countAfter) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tlet receivers = chat.get('members'),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tclient.rooms.addMembers(chat.get('_id'), member);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.addMember) {\n\t\t\t\t\tclient.newSystemMessage(chat, { whoAdded: socket.user, whomAdded: member })\n\t\t\t\t\t\t.then((message) => {\n\t\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\t\t\tmessage: 'New system message',\n\t\t\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.ADDMEMBER, {\n\t\t\t\t\t\tmessage: 'The member added',\n\t\t\t\t\t\tdata:    member,\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.ADDMEMBER, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonRemoveMember(client, socket, data = {}) {\n\t\tvar chat, countBefore, countAfter;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\tcountBefore = chat.get('members').length;\n\n\t\t\t\treturn client.removeMember(chat, data.member, socket.user)\n\t\t\t})\n\t\t\t.then((member) => {\n\t\t\t\tcountAfter = chat.get('members').length;\n\n\t\t\t\tif (countBefore === countAfter) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tclient.rooms.removeMember(chat.get('_id'), member);\n\n\t\t\t\tlet receivers = chat.get('members').concat(member),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.removeMember) {\n\t\t\t\t\tclient.newSystemMessage(chat, { whoRemove: socket.user, whomRemove: member })\n\t\t\t\t\t\t.then((message) => {\n\t\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\t\t\tmessage: 'New system message',\n\t\t\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.REMOVEMEMBER, {\n\t\t\t\t\t\tmessage: 'The member removed',\n\t\t\t\t\t\tdata:    member,\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.REMOVEMEMBER, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonNewMessage(client, socket, data = {}) {\n\t\tvar chat;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((result) => {\n\t\t\t\tif (!(chat = result)) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\treturn client.newMessage(chat, data, socket.user);\n\t\t\t})\n\t\t\t.then((message) => {\n\t\t\t\tclient.members.get(chat.get('members'))\n\t\t\t\t\t.forEach((socket) => {\n\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\tmessage: 'New message',\n\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.NEWMESSAGE, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindMessagesLast(client, socket, data = {}) {\n\t\tclient.findLastMessages(data.chatId, socket.user, data.limit, FLAGS.RECEIVER, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((messages) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDMESSAGESLAST, {\n\t\t\t\t\tchatId: data.chatId,\n\t\t\t\t\tdata:   messages\n\t\t\t\t})\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDMESSAGESLAST, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindMessagesFrom(client, socket, data = {}) {\n\t\tclient.findFromMessages(data.chatId, data.messageId, socket.user, data.limit, FLAGS.RECEIVER, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((messages) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDMESSAGESFROM, {\n\t\t\t\t\tchatId: data.chatId,\n\t\t\t\t\tdata:   messages\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDMESSAGESFROM, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindMessagesAt(client, socket, data = {}) {\n\t\tclient.findAtMessages(data.chatId, data.messageId, socket.user, data.limit, FLAGS.RECEIVER, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((messages) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDMESSAGESAT, { chatId: data.chatId, data: messages });\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDMESSAGESAT, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindChat(client, socket, data = {}) {\n\t\tclient.findChatById(socket.user, data.chatId)\n\t\t\t.then((chat) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDCHAT, { data: chat });\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDCHAT, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonFindChats(client, socket, data = {}) {\n\t\tclient.findChats(socket.user, data.limit, {\n\t\t\tfilter: data.filter, sort: data.sort, limit: data.limit, next: data.next, prev: data.prev\n\t\t})\n\t\t\t.then((chats) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.FINDCHATS, { data: chats });\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.FINDCHATS, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonChangeTitle(client, socket, data = {}) {\n\t\tvar oldTitle;\n\n\t\tclient.model('chat').findById(data.chatId)\n\t\t\t.then((chat) => {\n\t\t\t\tif (!chat) {\n\t\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t\t}\n\n\t\t\t\toldTitle = String(chat.get('title'));\n\n\t\t\t\treturn client.changeTitle(chat, data.title, socket.user)\n\t\t\t})\n\t\t\t.then((chat) => {\n\t\t\t\tlet receivers = chat.get('members'),\n\t\t\t\t    sockets   = client.members.get(receivers);\n\n\t\t\t\tif (chat.systemMessages && chat.systemMessages.changeTitle) {\n\t\t\t\t\tclient.newSystemMessage(chat, {\n\t\t\t\t\t\tchanged: socket.user, oldTitle: oldTitle, newTitle: chat.get('title')\n\t\t\t\t\t}).then((message) => {\n\t\t\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\t\t\tthis.emitResult(socket, client.EVENTS.NEWMESSAGE, {\n\t\t\t\t\t\t\t\tmessage: 'New system message',\n\t\t\t\t\t\t\t\tdata:    message.toJSON(),\n\t\t\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t}\n\n\t\t\t\tsockets.forEach((socket) => {\n\t\t\t\t\tthis.emitResult(socket, client.EVENTS.CHANGETITLE, {\n\t\t\t\t\t\tmessage: 'Title changed',\n\t\t\t\t\t\tdata:    chat.get('title'),\n\t\t\t\t\t\tchatId:  chat.get('_id')\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthis.emitError(socket, client.EVENTS.CHANGETITLE, { message: catchErrorMessage(error) });\n\t\t\t});\n\t}\n\n\tonReadMessage(client, socket, data = {}) {\n\t\tvar chat;\n\n\t\tif (!data.messagesId) {\n\t\t\tmessagesId = [];\n\t\t}\n\n\t\tdata.messagesId = data.messagesId.slice(0, 10);\n\t\t\n\t\tPromise.all([\n\t\t\tclient.model('chat').findOne({ _id: data.chatId, members: socket.user }).exec(),\n\t\t\tclient.model('message').find({ \n\t\t\t\t_id: { $in: data.messagesId }, \n\t\t\t\tchatId: data.chatId, \n\t\t\t\treceivers: socket.user,\n\t\t\t\tread: { $nin: data.messagesId }\n\t\t\t}).exec()\n\t\t])\n\t\t.then((results) => {\n\t\t\tvar messages = results[1];\n\t\t\tchat = results[0];\n\n\t\t\tif (!chat) {\n\t\t\t\tthrow new ClientError('Chat not found');\n\t\t\t}\n\n\t\t\treturn Promise.all(messages.map(function (message) {\n\t\t\t\treturn client.readMessage(chat, message, socket.user);\n\t\t\t}));\n\t\t})\n\t\t.then((results) => {\n\t\t\tsockets = client.members.get(chat.get('members'));\n\t\t\tsockets.forEach((socket) => {\n\t\t\t\tthis.emitResult(socket, client.EVENTS.READMESSAGE, {\n\t\t\t\t\tmessage:   'Message readed',\n\t\t\t\t\tmessagesId: results.map(function (message) { return message._id }),\n\t\t\t\t\tchatId:  \tchat._id\n\t\t\t\t});\n\t\t\t});\n\t\t})\n\t\t.catch((error) => {\n\t\t\tthis.emitError(socket, client.EVENTS.READMESSAGE, { message: catchErrorMessage(error) });\n\t\t});\n\t}\n}\n\nexport default ClientSocket;"]}