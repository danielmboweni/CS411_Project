{"version":3,"sources":["../../src/client/client.es6"],"names":[],"mappings":"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","file":"client.js","sourcesContent":["import { chatMessagesInc, singlePrivateChat, newChatOnGroup, activeReadMessage } from './validators';\nimport IO           from 'socket.io';\nimport db           from '../db';\nimport Chat         from '../chat';\nimport Rooms        from '../rooms';\nimport Members      from '../members';\nimport Message      from '../message';\nimport EventEmitter from 'events';\nimport util         from 'util';\nimport debugBase    from 'debug';\nimport _            from 'underscore';\nimport FLAGS        from '../flags';\nimport socketMixin  from '../socket';\nimport ClientSocket from './socket';\nimport ClientAction from './action';\nimport ClientError  from '../error';\n\nvar debug = debugBase('develop');\n\nrequire('source-map-support').install();\n\nclass Client extends EventEmitter {\n\t/**\n\t * @param server Http node.js server\n\t * @param {object} options\n\t * @param {String} options.collectionChat\n\t * @param {String} options.collectionMessages\n\t * @param {object} options.EVENTS\n\t * @param {String} options.eventPrefix\n\t */\n\tconstructor(server, options = {}) {\n\t\tsuper();\n\n\t\tif (!server) {\n\t\t\tthrow new Error('first argument required `http` server');\n\t\t}\n\n\t\tvar io, self = this;\n\t\tvar collectionChat, collectionChatMessages, EVENTS, eventPrefix;\n\n\t\tcollectionChat         = options.collectionChat || 'chats';\n\t\tcollectionChatMessages = options.collectionMessage || 'chats_messages';\n\n\t\teventPrefix = options.eventPrefix || '';\n\n\t\tthis.options = options;\n\n\t\toptions.chatMessagesInc = options.chatMessagesInc || true;\n\n\t\tEVENTS = {\n\t\t\tAUTHENTICATE:     'authenticate',\n\t\t\tJOIN:             'join',\n\t\t\tCREATE:           'create',\n\t\t\tLEAVE:            'leave',\n\t\t\tADDMEMBER:        'addMember',\n\t\t\tREMOVEMEMBER:     'removeMember',\n\t\t\tNEWMESSAGE:       'newMessage',\n\t\t\tNEWSYSTEMMESSAGE: 'newSystemMessage',\n\t\t\tCHANGETITLE:      'changeTitle',\n\t\t\tFINDMESSAGESLAST: 'findMessagesLast',\n\t\t\tFINDMESSAGESFROM: 'findMessagesFrom',\n\t\t\tFINDMESSAGESAT:   'findMessagesAt',\n\t\t\tFINDCHATS:        'findChats',\n\t\t\tFINDCHAT:         'findChat',\n\t\t\tACTIVE: \t\t  'active',\n\t\t\tREADMESSAGE: \t  'readMessage'\n\t\t};\n\n\t\t_.assign(EVENTS, _.pick(options.EVENTS || {}, Object.keys(EVENTS)));\n\n\t\tEVENTS = _.mapObject(EVENTS, function (value) {\n\t\t\treturn eventPrefix + value;\n\t\t});\n\n\t\tthis.EVENTS = EVENTS;\n\n\t\tthis.__validations = {};\n\t\tthis.__models      = {};\n\n\t\tthis.action = new ClientAction();\n\t\tthis.socket = new ClientSocket();\n\n\t\tthis.__members = this.members = new Members();\n\t\tthis.__rooms = this.rooms = new Rooms();\n\n\t\tthis.__models.chat = Chat({\n\t\t\tcollection: collectionChat,\n\t\t\tschema:     options.schemaChat || undefined\n\t\t});\n\n\t\tthis.__models.message = Message({\n\t\t\tcollection: collectionChatMessages,\n\t\t\tschema:     options.schemaMessage || undefined\n\t\t});\n\n\t\tthis.io = io = IO(server, {maxHttpBufferSize: 1000});\n\n\t\tio.on('connection', function (socket) {\n\t\t\tsocket.on(EVENTS.AUTHENTICATE, function (data) {\n\t\t\t\tself.socket.onAuthenticate(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.CREATE, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onCreate(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.LEAVE, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onLeave(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.ADDMEMBER, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onAddMember(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.REMOVEMEMBER, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onRemoveMember(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.NEWMESSAGE, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onNewMessage(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.CHANGETITLE, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onChangeTitle(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.FINDMESSAGESLAST, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onFindMessagesLast(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.FINDMESSAGESFROM, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onFindMessagesFrom(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.FINDMESSAGESAT, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onFindMessagesAt(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.FINDCHATS, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onFindChats(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.FINDCHAT, function (data) {\n\t\t\t\tself.authorize(this) && self.socket.onFindChat(self, this, data);\n\t\t\t});\n\n\t\t\tsocket.on(EVENTS.ACTIVE, function (data) {\n\t\t\t\tif (self.authorize(this)) {\n\t\t\t\t\tconsole.log('active', data.active);\n\t\t\t\t\tsocket.isActive = !!data.active;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tsocket.on('error', function (error) {\n\t\t\t\tconsole.log(error.stack);\n\t\t\t\tself.emit('error', this, error.event, error);\n\t\t\t});\n\n\t\t\tsocket.on('disconnect', function () {\n\t\t\t\tsocket.auth = false;\n\n\t\t\t\tself.members.remove(socket.user, socket);\n\t\t\t\tself.emit('disconnect', socket);\n\t\t\t});\n\n\t\t\t_.extend(socket, socketMixin);\n\t\t});\n\n\t\tif (this.options.chatMessagesInc) {\n\t\t\tthis.on(this.EVENTS.NEWMESSAGE, chatMessagesInc.bind(this));\n\t\t}\n\n\t\tif (this.options.singlePrivateChat) {\n\t\t\tthis.validate(this.EVENTS.CREATE, singlePrivateChat.bind(this));\n\t\t}\n\n\t\tif (this.options.newChatOnGroup) {\n\t\t\tthis.validate(this.EVENTS.ADDMEMBER, newChatOnGroup.bind(this));\n\t\t}\n\n\t\tif (this.options.activeReadMessage) {\n\t\t\tthis.validate(this.EVENTS.NEWMESSAGE, activeReadMessage.bind(this));\n\t\t}\n\t}\n\n\t/**\n\t * Return client event names\n\t *\n\t * @returns {EVENTS}\n\t */\n\tget eventNames() {\n\t\treturn this.EVENTS;\n\t}\n\n\t/**\n\t * Set client event names\n\t *\n\t * @param {object} events\n\t * @returns {void}\n\t */\n\tset eventNames(events) {\n\t\t_.defaults(this.EVENTS, events);\n\t}\n\n\t/**\n\t * Return module flags\n\t *\n\t * @returns {*}\n\t */\n\tget FLAGS() {\n\t\treturn FLAGS;\n\t}\n\n\t/**\n\t * Checks the authorization of the socket\n\t *\n\t * @param {Socket} socket\n\t * @returns {boolean}\n\t */\n\tauthorize(socket) {\n\t\treturn !!socket.auth;\n\t}\n\n\t/**\n\t * Return model by name (chat/message)\n\t *\n\t * var ChatModel = client.model('chat');\n\t * new ChatModel()\n\t *\n\t * @param {String} name\n\t * @returns {*}\n\t */\n\tmodel(name) {\n\t\treturn this.__models[name];\n\t}\n\n\t/**\n\t * Middleware for socket.io\n\t *\n\t * @param {function} cb\n\t * @returns {ChatClient}\n\t */\n\tuse(cb) {\n\t\tthis.io.use(cb);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Validate client event\n\t *\n\t * client.validate('addMember', function (socket, data, next) {\n\t *     if (data.flag !== client.FLAGS.MEMBER) {\n\t *       next(new Error('Not allowed'));\n\t *     }\n\t * })\n\t *\n\t *\n\t * @param {String} path\n\t * @param {function} cb\n\t * @returns {ChatClient}\n\t */\n\tvalidate(path, cb) {\n\t\tpath = path || 'default';\n\t\tcb   = cb || function () {\n\t\t\t};\n\n\t\tif (!this.__validations[path]) {\n\t\t\tthis.__validations[path] = [];\n\t\t}\n\n\t\tthis.__validations[path].push(cb);\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Create new chat\n\t *\n\t * @param {object} data\n\t * @param {String} data.name\n\t * @param {String} data.title\n\t * @param {ObjectId} creator\n\t * @returns {Promise}\n\t */\n\tcreate(data, creator) {\n\t\tvar chat = new (this.model('chat'))(data);\n\n\t\tchat.members = chat.members && chat.members.map(function (id) {\n\t\t\t\treturn db.ObjectId(id);\n\t\t\t}).filter(function (id) {\n\t\t\t\treturn !!id;\n\t\t\t});\n\n\t\tchat.setCreator(db.ObjectId(creator));\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.CREATE, {chat, creator, data})\n\t\t\t\t.then((post) => {\n\t\t\t\t\tpost.chat.save((error, result) => {\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(post.chat);\n\n\t\t\t\t\t\tthis.emit(this.EVENTS.CREATE, post.chat);\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Add member to chat\n\t *\n\t * @param {ChatModel} chat\n\t * @param {ObjectId} member\n\t * @param {ObjectId} performer\n\t * @param {Number} flag\n\t * @returns {Promise}\n\t */\n\taddMember(chat, member, performer = null, flag = FLAGS.MEMBER) {\n\t\tchat.addMember(member);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.ADDMEMBER, {chat, member, performer, flag})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.action.validate(flag, {chat, performer});\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tchat.save((error) => {\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(member);\n\n\t\t\t\t\t\tthis.emit(this.EVENTS.ADDMEMBER, chat, member);\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\treject(error);\n\t\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Remove member from chat\n\t *\n\t * @param {ChatModel} chat\n\t * @param {ObjectId} member\n\t * @param {ObjectId} performer\n\t * @param {Number} flag\n\t * @returns {Promise}\n\t */\n\tremoveMember(chat, member, performer = null, flag = FLAGS.AUTHOR) {\n\t\tchat.removeMember(member);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.REMOVEMEMBER, {chat, member, performer, flag})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.action.validate(flag, {chat, performer});\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tchat.update((error) => {\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(member);\n\n\t\t\t\t\t\tthis.emit(this.EVENTS.REMOVEMEMBER, chat, member);\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Create new message in chat\n\t *\n\t * @param {ChatModel} chat\n\t * @param {object} messageData\n\t * @param {String} messageData.text\n\t * @param {ObjectId} performer\n\t * @param {Number} flag\n\t * @returns {Promise}\n\t */\n\tnewMessage(chat, messageData, performer = null, flag = FLAGS.MEMBER) {\n\t\tvar message = null;\n\n\t\tmessage = new (this.model('message'))(messageData);\n\t\tmessage.setChat(chat);\n\t\tmessage.setAuthor(performer);\n\t\tmessage.setReceivers(chat.members);\n\t\tmessage.addAttachments(messageData.files);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.NEWMESSAGE, {chat, message, performer, flag})\n\t\t\t\t.then((post) => {\n\t\t\t\t\treturn this.action.validate(flag, {chat: post.chat, performer: post.performer})\n\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\tpost.message.save((error) => {\n\t\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tresolve(post.message);\n\n\t\t\t\t\t\t\t\tthis.emit(this.EVENTS.NEWMESSAGE, {chat: post.chat, message: post.message});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Change title in chat\n\t *\n\t * @param {ChatModel} chat\n\t * @param {String} title\n\t * @param {ObjectId} performer\n\t * @param {Number} flag\n\t * @returns {Promise}\n\t */\n\tchangeTitle(chat, title, performer = null, flag = FLAGS.MEMBER) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.CHANGETITLE, {chat, title, performer, flag})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.action.validate(flag, {chat, performer});\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tchat.setTitle(title)\n\t\t\t\t\t\t.update((error) => {\n\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(chat);\n\n\t\t\t\t\t\t\tthis.emit(this.EVENTS.CHANGETITLE, chat, title);\n\t\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Leave performer from chat\n\t *\n\t * @param {ChatModel} chat\n\t * @param {ObjectId} performer\n\t * @param flag\n\t * @returns {Promise}\n\t */\n\tleave(chat, performer, flag = FLAGS.MEMBER) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.LEAVE, {chat, performer, flag})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.action.validate(flag, {chat, performer});\n\t\t\t\t})\n\t\t\t\t.then(() => {\n\t\t\t\t\tchat.removeMember(performer);\n\t\t\t\t\tchat.update((error) => {\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(performer);\n\n\t\t\t\t\t\tthis.emit(this.EVENTS.LEAVE, chat, performer);\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Create new system message (member add/remove chat, changeTitle, or event)\n\t *\n\t * @param {ChatModel} chat\n\t * @param {object} data\n\t * @returns {Promise}\n\t */\n\tnewSystemMessage(chat, data) {\n\t\tvar message = null;\n\n\t\tmessage = new (this.model('message'))({text: ' '});\n\t\tmessage.setChat(chat);\n\t\tmessage.setSystemAuthor();\n\t\tmessage.setReceivers(chat.members);\n\t\tmessage.setSystem(data);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.NEWSYSTEMMESSAGE, {chat, message, data})\n\t\t\t\t.then((post) => {\n\t\t\t\t\tpost.message.save((error) => {\n\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(post.message);\n\n\t\t\t\t\t\tthis.emit(this.EVENTS.NEWSYSTEMMESSAGE, post.chat, post.message);\n\t\t\t\t\t});\n\t\t\t\t})\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\treadMessage(chat, message, performer = null, flag = FLAGS.AUTHOR) {\n\t\tmessage.setReaded(performer);\n\n\t\treturn new Promise((resolve ,reject) => {\n\t\t\tthis._validatePath(this.EVENTS.READMESSAGE, {chat, message, performer})\n\t\t\t\t.then((post) => {\n\t\t\t\t\tthis.action.validate(flag, {chat, performer})\n\t\t\t\t\t\t.then(function () {\n\t\t\t\t\t\t\tpost.message.update((error) => {\n\t\t\t\t\t\t\t\tif (error) {\n\t\t\t\t\t\t\t\t\treturn reject(error);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tresolve(post.message);\n\n\t\t\t\t\t\t\t\tthis.emit(this.EVENTS.READMESSAGE, post.message, post.chat, post.performer);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\n\t\t\t\t})\n\t\t});\n\t}\n\n\t/** find messages */\n\n\t/**\n\t * Find last message in chat\n\t *\n\t * @param {ObjectId} chatId\n\t * @param {ObjectId} user\n\t * @param {Number} limit\n\t * @param {Number} flag\n\t * @param {Object} criteria\n\t * @returns {Promise}\n\t */\n\tfindLastMessages(chatId, user, limit, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGESLAST, {chatId, user, limit, flag, criteria})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.model('message').findLast(chatId, user, limit, criteria);\n\t\t\t\t})\n\t\t\t\t.then(resolve)\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Find messages in chat, start from messageId\n\t *\n\t * @param {ObjectId} chatId\n\t * @param {ObjectId} messageId\n\t * @param {ObjectId} user\n\t * @param {Number} limit\n\t * @param {Number} flag\n\t * @param {Object} criteria\n\t * @returns {Promise}\n\t */\n\tfindFromMessages(chatId, messageId, user, limit, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGESFROM, {chatId, messageId, user, limit, flag, criteria})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.model('message').findFrom(chatId, messageId, user, limit, criteria)\n\t\t\t\t})\n\t\t\t\t.then(resolve, reject)\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Find messages in chat, to the message id\n\t *\n\t * @param {ObjectId} chatId\n\t * @param {ObjectId} messageId\n\t * @param {ObjectId} user\n\t * @param {Number} limit\n\t * @param {Number} flag\n\t * @param {Object} criteria\n\t * @returns {Promise}\n\t */\n\tfindAtMessages(chatId, messageId, user, limit, flag = FLAGS.RECEIVER, criteria = {}) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.FINDMESSAGESAT, {chatId, messageId, user, limit, flag, criteria})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.model('message').findAt(chatId, messageId, user, limit, criteria)\n\t\t\t\t})\n\t\t\t\t.then(resolve, reject)\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/** find chats */\n\tfindChats(user, limit = 10, criteria = {}) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.FINDCHATS, {user, limit, criteria})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.model('chat').findAllByMember(user, limit, criteria)\n\t\t\t\t})\n\t\t\t\t.then(resolve, reject)\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/** find one chat */\n\tfindChatById(user, chatId, criteria = {}) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._validatePath(this.EVENTS.FINDCHAT, {user, chatId, criteria})\n\t\t\t\t.then(() => {\n\t\t\t\t\treturn this.model('chat').findByMember(chatId, user, criteria)\n\t\t\t\t})\n\t\t\t\t.then(resolve, reject)\n\t\t\t\t.catch(reject);\n\t\t});\n\t}\n\n\t/**\n\t * Used in public methods before/save update models (middleware)\n\t *\n\t * @param {String} path\n\t * @param {Socket} socket\n\t * @param {object} data\n\t * @returns {Promise}\n\t * @private\n\t */\n\t_validatePath(path, data) {\n\t\tvar validations = this.__validations[path],\n\t\t    index       = 0;\n\n\t\tif (!validations) {\n\t\t\tvalidations = [];\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tfunction next(error) {\n\t\t\t\tif (typeof error !== \"undefined\") {\n\t\t\t\t\treturn reject(error);\n\t\t\t\t}\n\n\t\t\t\tvar validation = validations[index];\n\n\t\t\t\tif (validation) {\n\t\t\t\t\tindex++;\n\t\t\t\t\treturn validation(data, next);\n\t\t\t\t}\n\n\t\t\t\tif (index === validations.length) {\n\t\t\t\t\treturn resolve(data);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tnext();\n\t\t});\n\t}\n\n\t/**\n\t * Close socket.io, remove all event listeners\n\t *\n\t */\n\tdestroy() {\n\t\tthis.io.close();\n\t\tthis.removeAllListeners();\n\t}\n}\n\nexport default Client;"]}