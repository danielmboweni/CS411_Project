{"version":3,"sources":["../src/queryResolver.es6"],"names":[],"mappings":"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","file":"queryResolver.js","sourcesContent":["(function () {\n\t\"use strict\";\n\tvar extend = require('extend'),\n\t\tdb     = require('./db'),\n\t\tdebug  = require('debug')('develop'),\n\t\t_      = require('underscore');\n\n\tfunction castSortValue(value) {\n\t\tvar _v = parseInt(value, 10);\n\n\t\treturn (_v !== 1 && _v !== -1) ? 1 : _v;\n\t}\n\n\tclass QueryResolver {\n\t\tconstructor() {\n\t\t\tthis.query    = {};\n\t\t\tthis.select   = {};\n\t\t\tthis.sort     = {};\n\t\t\tthis.limit    = null;\n\t\t\tthis.schema   = {};\n\t\t\tthis.next     = null;\n\t\t\tthis.prev     = null;\n\t\t\tthis.criteria = {};\n\t\t}\n\n\t\tcollection(collection) {\n\t\t\tthis.collection = collection;\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetQuery(query) {\n\t\t\tthis.query = query;\n\n\t\t\treturn this;\n\t\t}\n\n\t\taddQuery(query) {\n\t\t\textend(this.query, query);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetLimit(limit = null) {\n\t\t\tif (limit) {\n\t\t\t\tthis.limit = Math.abs(limit) > 50 ? 50 : (Math.abs(limit) || 10);\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetSort(sort) {\n\t\t\tthis.sort = sort;\n\n\t\t\treturn this;\n\t\t}\n\n\t\taddSort(sort) {\n\t\t\textend(this.sort, sort);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetSelect(select) {\n\t\t\tthis.select = select;\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetSchema(schema) {\n\t\t\tthis.schema = schema;\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetNext() {\n\t\t\tthis.next = db.ObjectId(this.criteria.next);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tsetPrev() {\n\t\t\tthis.prev = db.ObjectId(this.criteria.prev);\n\n\t\t\treturn this;\n\t\t}\n\n\t\tbindCriteria(criteria = {}) {\n\t\t\tthis.criteria = criteria;\n\n\t\t\tthis.criteria.limit && this.setLimit(this.criteria.limit);\n\t\t\tthis.criteria.next && this.setNext(this.criteria.next);\n\t\t\tthis.criteria.prev && this.setPrev(this.criteria.prev);\n\n\t\t\tif (this.criteria.filter) {\n\t\t\t\tif (!_.isObject(this.criteria.filter)) {\n\t\t\t\t\tthis.criteria.filter = {};\n\t\t\t\t}\n\n\t\t\t\tObject.keys(this.criteria.filter).forEach((key) => {\n\t\t\t\t\tif (!this.query.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\t\tswitch (this.schema.properties[key].type) {\n\t\t\t\t\t\t\tcase 'string':\n\t\t\t\t\t\t\t\tthis.query[key] = String(this.criteria.filter[key]);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'number':\n\t\t\t\t\t\t\t\tthis.query[key] = Number(this.criteria.filter[key]);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'date-time':\n\t\t\t\t\t\t\t\tthis.query[key] = new Date(this.criteria.filter[key]) || null;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'object':\n\t\t\t\t\t\t\t\tif (key.toLowerCase().match(/id$/)) {\n\t\t\t\t\t\t\t\t\tthis.query[key] = db.ObjectId(this.criteria.filter[key]) || null;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tthis.query[key] = String(this.criteria.filter[key]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (this.criteria.sort) {\n\t\t\t\tif (!_.isObject(this.criteria.sort)) {\n\t\t\t\t\tthis.criteria.sort = {};\n\t\t\t\t}\n\n\t\t\t\tObject.keys(this.criteria.sort).forEach((key) => {\n\t\t\t\t\tif (!this.sort.hasOwnProperty(key) && this.schema.properties.hasOwnProperty(key)) {\n\t\t\t\t\t\tthis.sort[key] = castSortValue(this.criteria.sort[key]);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this;\n\t\t}\n\n\t\tfind() {\n\t\t\tvar cursor,\n\t\t\t\tcollectionName = this.collection,\n\t\t\t\tquery          = this.query,\n\t\t\t\tselect         = this.select,\n\t\t\t\tlimit          = this.limit,\n\t\t\t\tsort           = this.sort,\n\t\t\t\tnext           = this.next,\n\t\t\t\tprev           = this.prev;\n\n\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tif (next || prev) {\n\t\t\t\t\t\tif (!query.$and) {\n\t\t\t\t\t\t\tquery.$and = [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tnext && query.$and.push({ _id: { $gt: next } });\n\t\t\t\t\t\tprev && query.$and.push({ _id: { $lt: prev } });\n\t\t\t\t\t}\n\n\t\t\t\t\tcursor = connect.collection(collectionName).find(query, select);\n\n\t\t\t\t\tif (Object.keys(sort).length > 0) cursor.sort(sort);\n\t\t\t\t\tif (isFinite(limit)) cursor.limit(limit);\n\n\t\t\t\t\tcursor.toArray(function (err, res) {\n\t\t\t\t\t\terr ? reject(err) : resolve(res);\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tfindOne() {\n\t\t\tvar cursor,\n\t\t\t\tcollectionName = this.collection,\n\t\t\t\tquery          = this.query,\n\t\t\t\tselect         = this.select;\n\n\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\tdb.getConnect(function (connect) {\n\t\t\t\t\tcursor = connect.collection(collectionName);\n\t\t\t\t\tcursor.findOne(query, function (err, res) {\n\t\t\t\t\t\terr ? reject(err) : resolve(res);\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tmodule.exports = QueryResolver;\n}());"]}